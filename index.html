<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• ULTRA AI Hybrid Predictor + Size Engine</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#0a0a0a,#1a1a2e,#0a0a0a);min-height:100vh;color:#fff;padding:10px}
        .container{max-width:650px;margin:0 auto}
        h1{text-align:center;font-size:20px;margin-bottom:8px;background:linear-gradient(90deg,#ff6b6b,#4ecdc4,#a855f7,#f59e0b,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .ai-badge{text-align:center;margin-bottom:12px}
        .ai-badge span{background:linear-gradient(135deg,#ff6b6b,#a855f7);padding:4px 14px;border-radius:15px;font-size:10px;font-weight:bold}
        .input-section{background:linear-gradient(145deg,#1e1e2e,#2a2a3e);border-radius:12px;padding:14px;margin-bottom:12px;border:2px solid #667eea}
        .count-display{text-align:center;color:#aaa;margin-bottom:8px;font-size:.9em}
        .count-display span{color:#f093fb;font-weight:bold}
        .auto-notice{background:linear-gradient(135deg,#ff6b6b,#ee5a24);color:#fff;padding:8px;border-radius:8px;font-size:.85em;text-align:center;margin-bottom:8px;display:none}
        .auto-notice.show{display:block;animation:shake .5s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        .nums-display{background:#0d0d1a;min-height:50px;border-radius:10px;padding:10px;margin-bottom:12px;display:flex;flex-wrap:wrap;gap:7px;align-items:center;border:2px dashed #667eea}
        .chip{padding:7px 14px;border-radius:20px;font-weight:bold;font-size:1.1em;color:#fff;cursor:pointer;transition:.3s;position:relative;animation:pop .3s}
        @keyframes pop{0%{transform:scale(0);opacity:0}70%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
        .chip:hover{transform:scale(1.1)}
        .chip::after{content:'√ó';position:absolute;top:-5px;right:-5px;background:#ff4444;width:16px;height:16px;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;opacity:0;transition:.2s}
        .chip:hover::after{opacity:1}
        .placeholder{color:#555;font-style:italic;font-size:.9em}
        .num-buttons{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:12px}
        .nbtn{padding:18px;font-size:1.4em;font-weight:bold;border:none;border-radius:12px;cursor:pointer;transition:.2s;color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.3)}
        .nbtn:hover{transform:translateY(-3px);box-shadow:0 6px 18px rgba(0,0,0,.4)}
        .nbtn:active{transform:scale(.95)}
        .act-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
        .abtn{padding:11px;font-size:.95em;font-weight:bold;border:none;border-radius:10px;cursor:pointer;color:#fff;transition:.2s}
        .abtn.cl{background:linear-gradient(135deg,#ff6b6b,#ee5a24)}
        .abtn.un{background:linear-gradient(135deg,#ffa726,#fb8c00)}
        .abtn.rn{background:linear-gradient(135deg,#26c6da,#00acc1)}
        .min-hint{text-align:center;color:#f5576c;font-size:.85em;display:none}
        .min-hint.show{display:block;animation:fadeIn .3s}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

        /* Size Mapping Display */
        .size-map{background:#0d0d1a;border-radius:8px;padding:8px;margin-bottom:10px;display:flex;flex-wrap:wrap;gap:4px;justify-content:center;border:1px solid #3a3a5a}
        .size-tag{padding:3px 8px;border-radius:6px;font-size:.7em;font-weight:bold;color:#fff}
        .size-tag.st-s{background:linear-gradient(135deg,#26c6da,#00838f)}
        .size-tag.st-b{background:linear-gradient(135deg,#ffa726,#e65100)}

        /* Signal Box */
        .signal-box{background:linear-gradient(145deg,#0f172a,#1e293b);border:3px solid #22c55e;border-radius:15px;padding:20px;text-align:center;margin-bottom:14px;position:relative;overflow:hidden;animation:sigPulse 2s infinite}
        @keyframes sigPulse{0%,100%{box-shadow:0 0 15px rgba(34,197,94,.3)}50%{box-shadow:0 0 35px rgba(34,197,94,.6)}}
        .signal-box.red-sig{border-color:#ff4444;animation-name:sigPulseR}
        @keyframes sigPulseR{0%,100%{box-shadow:0 0 15px rgba(255,68,68,.3)}50%{box-shadow:0 0 35px rgba(255,68,68,.6)}}
        .signal-box.violet-sig{border-color:#8844ff;animation-name:sigPulseV}
        @keyframes sigPulseV{0%,100%{box-shadow:0 0 15px rgba(136,68,255,.3)}50%{box-shadow:0 0 35px rgba(136,68,255,.6)}}
        .sig-label{font-size:11px;color:#888;margin-bottom:6px;text-transform:uppercase;letter-spacing:2px}
        .sig-num{font-size:4em;font-weight:bold;text-shadow:0 0 20px rgba(255,255,255,.3);line-height:1}
        .sig-color{display:inline-block;padding:6px 20px;border-radius:20px;font-weight:bold;font-size:1.1em;margin:8px 4px}
        .sig-color.red{background:#ff4444}.sig-color.green{background:#00c853}.sig-color.violet{background:#8844ff}
        .sig-color.red-violet{background:linear-gradient(135deg,#ff4444,#8844ff)}
        .sig-color.green-violet{background:linear-gradient(135deg,#00c853,#8844ff)}
        .sig-size{display:inline-block;padding:4px 14px;border-radius:14px;font-size:.9em;margin-left:6px;font-weight:bold}
        .sig-size.sz-big{background:linear-gradient(135deg,#ffa726,#e65100)}
        .sig-size.sz-small{background:linear-gradient(135deg,#26c6da,#00838f)}
        .sig-strength{font-size:1em;margin-top:8px;font-weight:bold}
        .sig-strength.high{color:#22c55e}.sig-strength.med{color:#f59e0b}.sig-strength.low{color:#ef4444}

        /* SIZE ENGINE Signal */
        .size-engine-box{background:linear-gradient(145deg,#0f172a,#1e293b);border:3px solid #ffa726;border-radius:15px;padding:18px;text-align:center;margin-bottom:14px;position:relative;overflow:hidden;animation:szPulse 2s infinite}
        @keyframes szPulse{0%,100%{box-shadow:0 0 15px rgba(255,167,38,.3)}50%{box-shadow:0 0 35px rgba(255,167,38,.6)}}
        .size-engine-box.sz-big-sig{border-color:#ffa726;animation-name:szPulseB}
        @keyframes szPulseB{0%,100%{box-shadow:0 0 15px rgba(255,167,38,.3)}50%{box-shadow:0 0 35px rgba(255,167,38,.6)}}
        .size-engine-box.sz-small-sig{border-color:#26c6da;animation-name:szPulseS}
        @keyframes szPulseS{0%,100%{box-shadow:0 0 15px rgba(38,198,218,.3)}50%{box-shadow:0 0 35px rgba(38,198,218,.6)}}
        .sz-label{font-size:10px;color:#888;text-transform:uppercase;letter-spacing:2px;margin-bottom:4px}
        .sz-pred{font-size:3.5em;font-weight:bold;line-height:1}
        .sz-pred.sz-b-txt{color:#ffa726}.sz-pred.sz-s-txt{color:#26c6da}
        .sz-conf-row{display:flex;justify-content:center;gap:12px;margin-top:8px;flex-wrap:wrap}
        .sz-badge{padding:5px 14px;border-radius:14px;font-weight:bold;font-size:.9em;color:#fff}
        .sz-prob-bar{margin-top:10px;display:flex;gap:0;height:30px;border-radius:10px;overflow:hidden;border:2px solid rgba(255,255,255,.1)}
        .sz-prob-fill{display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:.8em;transition:width .8s ease-out;color:#fff}
        .sz-prob-big{background:linear-gradient(90deg,#ffa726,#e65100)}
        .sz-prob-small{background:linear-gradient(90deg,#26c6da,#00838f)}
        .sz-strength{font-size:.95em;margin-top:8px;font-weight:bold}
        .sz-strength.high{color:#22c55e}.sz-strength.med{color:#f59e0b}.sz-strength.low{color:#ef4444}
        .sz-detail{font-size:.75em;color:#888;margin-top:6px}

        /* Results */
        .results{display:none;animation:fadeIn .4s}
        .results.show{display:block}
        .section{background:linear-gradient(145deg,#1e1e2e,#2a2a3e);border-radius:10px;padding:14px;margin-bottom:12px;border:1px solid #3a3a5a}
        .section.highlight{border:2px solid #a855f7;box-shadow:0 0 15px rgba(168,85,247,.2)}
        .sec-title{font-size:13px;color:#f093fb;margin-bottom:10px;font-weight:bold}

        /* Top 3 */
        .top3{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-bottom:14px}
        .top-card{text-align:center;padding:14px;background:linear-gradient(145deg,#1e1e2e,#2a2a3e);border-radius:12px;border:2px solid;min-width:90px}
        .top-card.r1{border-color:#fbbf24;box-shadow:0 0 12px rgba(251,191,36,.4)}
        .top-card.r2{border-color:#94a3b8}.top-card.r3{border-color:#f97316}
        .top-rank{font-size:10px;color:#888;margin-bottom:4px}
        .top-num{width:55px;height:55px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:bold;margin:0 auto 6px;color:#fff}
        .top-pct{font-size:16px;font-weight:bold;color:#22c55e}
        .top-lbl{font-size:9px;color:#888;margin-top:2px}

        /* Category */
        .cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
        .cat-box{background:linear-gradient(145deg,#1e1e2e,#2a2a3e);border-radius:8px;padding:10px;text-align:center;border:1px solid #3a3a5a}
        .cat-lbl{font-size:9px;color:#888;margin-bottom:3px}
        .cat-val{font-size:14px;font-weight:bold}
        .cat-pct{font-size:10px;margin-top:2px}

        /* Quick Stats */
        .stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:12px}
        .stat{background:rgba(255,255,255,.08);padding:8px;border-radius:8px;text-align:center}
        .stat .lbl{font-size:.7em;color:#888}.stat .val{font-size:1.2em;font-weight:bold}
        .stat .val.rt{color:#ff4444}.stat .val.gt{color:#00c853}.stat .val.vt{color:#8844ff}
        .stat .val.bt{color:#ffa726}.stat .val.smt{color:#26c6da}

        /* Meters */
        .meter-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
        .meter-lbl{min-width:70px;font-weight:bold;font-size:.85em}
        .meter-lbl.rl{color:#ff4444}.meter-lbl.gl{color:#00c853}.meter-lbl.vl{color:#8844ff}
        .meter-lbl.bl{color:#ffa726}.meter-lbl.sl{color:#26c6da}
        .meter-bg{flex:1;height:22px;background:rgba(255,255,255,.08);border-radius:11px;overflow:hidden}
        .meter-fill{height:100%;border-radius:11px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:.75em;color:#fff;transition:width .8s ease-out;min-width:28px}
        .meter-fill.rf{background:linear-gradient(90deg,#ff4444,#cc0000)}
        .meter-fill.gf{background:linear-gradient(90deg,#00c853,#009624)}
        .meter-fill.vf{background:linear-gradient(90deg,#8844ff,#6600cc)}
        .meter-fill.bf{background:linear-gradient(90deg,#ffa726,#fb8c00)}
        .meter-fill.sf{background:linear-gradient(90deg,#26c6da,#00acc1)}
        .meter-pct{min-width:40px;text-align:right;font-weight:bold;font-size:.9em}

        /* Streaks */
        .streak-badges{display:flex;flex-wrap:wrap;gap:6px}
        .sbadge{padding:5px 12px;border-radius:16px;font-size:.8em;font-weight:bold;color:#fff}
        .sbadge.hot{background:linear-gradient(135deg,#ff4444,#ff6b6b)}
        .sbadge.warm{background:linear-gradient(135deg,#ffa726,#fb8c00)}
        .sbadge.cool{background:linear-gradient(135deg,#26c6da,#00acc1)}
        .sbadge.neutral{background:rgba(255,255,255,.12)}

        /* Probability Grid */
        .prob-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
        .prob-item{background:linear-gradient(145deg,#2a2a3e,#3a3a4e);border-radius:8px;padding:10px;text-align:center;border:1px solid #4a4a6a;transition:.2s}
        .prob-item:hover{transform:scale(1.04);border-color:#a855f7}
        .prob-num{width:36px;height:36px;border-radius:50%;margin:0 auto 5px;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:bold;color:#fff}
        .prob-pct{font-size:12px;font-weight:bold}
        .pct-h{color:#22c55e}.pct-m{color:#f59e0b}.pct-l{color:#ef4444}
        .prob-sz{font-size:8px;color:#888;margin-top:2px}

        /* Ball colors */
        .c0{background:linear-gradient(135deg,#ff4444,#8844ff)}
        .c1{background:linear-gradient(135deg,#00c853,#009624)}
        .c2{background:linear-gradient(135deg,#ff4444,#cc0000)}
        .c3{background:linear-gradient(135deg,#00c853,#009624)}
        .c4{background:linear-gradient(135deg,#ff4444,#cc0000)}
        .c5{background:linear-gradient(135deg,#00c853,#8844ff)}
        .c6{background:linear-gradient(135deg,#ff4444,#cc0000)}
        .c7{background:linear-gradient(135deg,#00c853,#009624)}
        .c8{background:linear-gradient(135deg,#ff4444,#cc0000)}
        .c9{background:linear-gradient(135deg,#00c853,#009624)}

        /* Hot/Cold */
        .hc-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
        .hc-box{background:rgba(255,255,255,.05);border-radius:8px;padding:10px;border:1px solid #3a3a5a}
        .hc-title{font-size:12px;margin-bottom:6px;font-weight:bold}
        .hc-hot{color:#ef4444}.hc-cold{color:#3b82f6}
        .hc-nums{display:flex;gap:6px;flex-wrap:wrap}
        .hc-ball{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:13px;color:#fff}

        /* Analysis */
        .analysis-item{padding:9px;margin:6px 0;background:rgba(255,255,255,.04);border-radius:7px;border-left:3px solid #667eea;font-size:.85em;color:#ddd}
        .analysis-item.hl{border-left-color:#f5576c;background:rgba(245,87,108,.08)}
        .analysis-item.sz{border-left-color:#ffa726;background:rgba(255,167,38,.08)}

        /* Pattern Matches */
        .match-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .match-cnt{background:#a855f7;color:#fff;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:bold}
        .flt-row{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
        .flt-btn{padding:5px 10px;border:none;border-radius:5px;cursor:pointer;font-size:10px;background:#3a3a5a;color:#fff;transition:.2s}
        .flt-btn:hover,.flt-btn.active{background:linear-gradient(135deg,#a855f7,#7c3aed)}
        .srch{padding:5px 8px;border:2px solid #3a3a5a;border-radius:5px;background:#1a1a2e;color:#fff;width:120px;outline:none;font-size:10px}
        .srch:focus{border-color:#a855f7}
        .match-list{max-height:250px;overflow-y:auto}
        .pat-item{background:linear-gradient(145deg,#252535,#353545);border-radius:6px;padding:8px;margin-bottom:5px;border-left:3px solid;transition:.2s}
        .pat-item:hover{transform:translateX(2px)}
        .pat-h{border-color:#22c55e}.pat-m{border-color:#f59e0b}.pat-lo{border-color:#ef4444}
        .pat-name{font-weight:bold;margin-bottom:2px;display:flex;justify-content:space-between;font-size:11px}
        .pat-badge{font-size:8px;padding:2px 6px;border-radius:6px;background:#22c55e;color:#000}
        .pat-match{font-size:10px;color:#888}
        .pat-next{font-size:10px;color:#4ecdc4;margin-top:2px;display:flex;align-items:center;gap:6px}
        .next-balls{display:flex;gap:3px}
        .next-ball{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;color:#fff}

        /* All patterns toggle */
        .all-sec{background:linear-gradient(145deg,#1e1e2e,#2a2a3e);border-radius:10px;padding:12px;border:1px solid #3a3a5a;margin-bottom:12px}
        .all-title{font-size:13px;color:#a855f7;display:flex;justify-content:space-between;align-items:center}
        .tog-btn{background:linear-gradient(135deg,#3a3a5a,#4a4a6a);border:none;color:#fff;padding:5px 12px;border-radius:6px;cursor:pointer;font-size:10px}
        .tog-btn:hover{background:linear-gradient(135deg,#a855f7,#7c3aed)}
        .pat-grid{display:none;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:5px;max-height:300px;overflow-y:auto;margin-top:8px}
        .pat-grid.show{display:grid}
        .mini-pat{background:#252535;border-radius:5px;padding:5px;font-size:10px}
        .mini-name{color:#4ecdc4;font-weight:bold}.mini-seq{color:#888;font-size:9px}

        /* Copy Section */
        .share-box{background:#0d0d1a;color:#ddd;padding:10px;border-radius:8px;font-size:.82em;line-height:1.7;white-space:pre-wrap;word-break:break-word;margin-bottom:10px;border:1px solid #333;max-height:180px;overflow-y:auto}
        .copy-btn{width:100%;padding:14px;font-size:1.1em;font-weight:bold;border:none;border-radius:10px;cursor:pointer;background:linear-gradient(135deg,#26c6da,#00acc1);color:#fff;transition:.3s}
        .copy-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(38,198,218,.4)}
        .copy-btn.copied{background:linear-gradient(135deg,#4CAF50,#388E3C)}

        /* Toast */
        .toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);background:linear-gradient(135deg,#4CAF50,#388E3C);color:#fff;padding:12px 30px;border-radius:30px;font-weight:bold;z-index:9999;box-shadow:0 5px 25px rgba(0,0,0,.4);transition:transform .4s;pointer-events:none}
        .toast.show{transform:translateX(-50%) translateY(0)}

        /* Confidence bar */
        .conf-bg{background:rgba(255,255,255,.1);border-radius:10px;height:28px;overflow:hidden}
        .conf-fill{height:100%;background:linear-gradient(90deg,#f093fb,#f5576c);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:.85em;transition:width 1s ease-out}

        ::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:#1a1a2e}::-webkit-scrollbar-thumb{background:linear-gradient(180deg,#4a4a6a,#a855f7);border-radius:3px}
        @media(max-width:500px){.cat-grid{grid-template-columns:repeat(2,1fr)}.prob-grid{grid-template-columns:repeat(5,1fr)}.stats-row{grid-template-columns:repeat(5,1fr)}}
    </style>
</head>
<body>
<div class="container">
    <h1>üî• ULTRA AI HYBRID + SIZE ENGINE üî•</h1>
    <div class="ai-badge"><span>ü§ñ HYBRID v7.0 ‚Äî 50000+ Patterns + Rule AI + Size Engine 2025</span></div>

    <div class="input-section">
        <div class="count-display">Numbers: <span id="cnt">0</span>/15 <span style="color:#26c6da;font-size:.85em">(‡§™‡•Å‡§∞‡§æ‡§®‡•á ‚Üí ‡§®‡§è | FIFO Sliding Window)</span></div>
        <div class="auto-notice" id="autoNotice">‚ö†Ô∏è ‡§∏‡§¨‡§∏‡•á ‡§™‡•Å‡§∞‡§æ‡§®‡§æ number auto-remove ‡§π‡•Å‡§Ü! (FIFO)</div>
        <div class="nums-display" id="numsDisplay"><span class="placeholder">üëÜ ‡§®‡•Ä‡§ö‡•á buttons ‡§∏‡•á numbers add ‡§ï‡§∞‡•á‡§Ç...</span></div>
        <!-- Size Mapping Display (Rule 2 & 8) -->
        <div class="size-map" id="sizeMap"></div>
        <!-- Dynamic Buttons Generated by JS (Rule 3) -->
        <div class="num-buttons" id="numBtnsContainer"></div>
        <div class="act-btns">
            <button class="abtn cl" onclick="clearAll()">üóëÔ∏è Clear</button>
            <button class="abtn un" onclick="undoLast()">‚Ü©Ô∏è Undo</button>
            <button class="abtn rn" onclick="addRandom()">üé≤ Random</button>
        </div>
        <div class="min-hint" id="minHint">‚ö° ‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 3 numbers ‡§°‡§æ‡§≤‡•á‡§Ç ‚Äî auto predict!</div>
    </div>

    <div class="results" id="results">
        <!-- Main Number Signal -->
        <div class="signal-box" id="signalBox">
            <div class="sig-label">üéØ HYBRID AI SIGNAL</div>
            <div class="sig-num" id="sigNum">-</div>
            <div>
                <span class="sig-color" id="sigColor">-</span>
                <span class="sig-size" id="sigSize">-</span>
            </div>
            <div class="sig-strength" id="sigStrength">-</div>
        </div>

        <!-- SIZE ENGINE Signal (Rules 9-14) -->
        <div class="size-engine-box" id="sizeEngineBox">
            <div class="sz-label">üìè ULTRA SIZE ENGINE 2025</div>
            <div class="sz-pred" id="szPred">-</div>
            <div class="sz-prob-bar">
                <div class="sz-prob-fill sz-prob-big" id="szBarBig" style="width:50%">BIG 50%</div>
                <div class="sz-prob-fill sz-prob-small" id="szBarSmall" style="width:50%">SMALL 50%</div>
            </div>
            <div class="sz-conf-row">
                <span class="sz-badge" id="szBigBadge" style="background:#ffa726">üî∫ BIG: 50%</span>
                <span class="sz-badge" id="szSmallBadge" style="background:#26c6da">üîª SMALL: 50%</span>
            </div>
            <div class="sz-strength" id="szStrength">-</div>
            <div class="sz-detail" id="szDetail"></div>
        </div>

        <!-- Top 3 -->
        <div class="top3" id="top3"></div>

        <!-- Categories -->
        <div class="cat-grid" id="catGrid"></div>

        <!-- Quick Stats (5 columns now) -->
        <div class="stats-row">
            <div class="stat"><div class="lbl">üî¥ Red</div><div class="val rt" id="sR">0</div></div>
            <div class="stat"><div class="lbl">üü¢ Green</div><div class="val gt" id="sG">0</div></div>
            <div class="stat"><div class="lbl">üü£ Violet</div><div class="val vt" id="sV">0</div></div>
            <div class="stat"><div class="lbl">üî∫ Big</div><div class="val bt" id="sBig">0</div></div>
            <div class="stat"><div class="lbl">üîª Small</div><div class="val smt" id="sSmall">0</div></div>
        </div>

        <!-- Color Meters -->
        <div class="section">
            <div class="sec-title">üé® Color Distribution</div>
            <div class="meter-row"><span class="meter-lbl rl">üî¥ Red</span><div class="meter-bg"><div class="meter-fill rf" id="rmBar" style="width:0%"></div></div><span class="meter-pct" id="rmPct">0%</span></div>
            <div class="meter-row"><span class="meter-lbl gl">üü¢ Green</span><div class="meter-bg"><div class="meter-fill gf" id="gmBar" style="width:0%"></div></div><span class="meter-pct" id="gmPct">0%</span></div>
            <div class="meter-row"><span class="meter-lbl vl">üü£ Violet</span><div class="meter-bg"><div class="meter-fill vf" id="vmBar" style="width:0%"></div></div><span class="meter-pct" id="vmPct">0%</span></div>
        </div>

        <!-- Size Meters (Rule 13: Confidence Visualization) -->
        <div class="section">
            <div class="sec-title">üìè Size Distribution (Frequency-Based)</div>
            <div class="meter-row"><span class="meter-lbl bl">üî∫ Big</span><div class="meter-bg"><div class="meter-fill bf" id="bmBar" style="width:0%"></div></div><span class="meter-pct" id="bmPct">0%</span></div>
            <div class="meter-row"><span class="meter-lbl sl">üîª Small</span><div class="meter-bg"><div class="meter-fill sf" id="smBar" style="width:0%"></div></div><span class="meter-pct" id="smPct">0%</span></div>
        </div>

        <!-- Streaks -->
        <div class="section">
            <div class="sec-title">üî• Streaks & Trends</div>
            <div class="streak-badges" id="streaks"></div>
        </div>

        <!-- Hot/Cold -->
        <div class="hc-row" id="hcRow">
            <div class="hc-box"><div class="hc-title hc-hot">üî• HOT</div><div class="hc-nums" id="hotN"></div></div>
            <div class="hc-box"><div class="hc-title hc-cold">‚ùÑÔ∏è COLD</div><div class="hc-nums" id="coldN"></div></div>
        </div>

        <!-- Probabilities -->
        <div class="section">
            <div class="sec-title">üìà All Digit Probabilities</div>
            <div class="prob-grid" id="probGrid"></div>
        </div>

        <!-- Confidence -->
        <div class="section">
            <div class="sec-title">üìä Overall Confidence Level</div>
            <div class="conf-bg"><div class="conf-fill" id="confBar" style="width:0%">0%</div></div>
        </div>

        <!-- Analysis -->
        <div class="section">
            <div class="sec-title">üîç Pattern + Size Analysis (17 Rules Applied)</div>
            <div id="analysisDiv"></div>
        </div>

        <!-- Pattern Matches -->
        <div class="section highlight" id="matchSec">
            <div class="match-header">
                <span class="sec-title" style="margin:0">üéØ 50000+ Pattern Matches</span>
                <span class="match-cnt" id="matchCnt">0</span>
            </div>
            <div class="flt-row">
                <button class="flt-btn active" onclick="fltPat('all',this)">All</button>
                <button class="flt-btn" onclick="fltPat('high',this)">80%+</button>
                <button class="flt-btn" onclick="fltPat('med',this)">60%+</button>
                <input type="text" class="srch" id="srch" placeholder="üîç Search..." oninput="srchPat()">
            </div>
            <div class="match-list" id="matchList"><div style="text-align:center;color:#888;padding:15px">Click numbers to start...</div></div>
        </div>

        <!-- All Patterns -->
        <div class="all-sec">
            <div class="all-title"><span>üìã 50000+ PATTERNS</span><button class="tog-btn" onclick="togAll()">Show/Hide</button></div>
            <div class="pat-grid" id="allGrid"></div>
        </div>

        <!-- Copy -->
        <div class="section">
            <div class="sec-title">üìã Result Copy ‡§ï‡§∞‡•á‡§Ç</div>
            <div class="share-box" id="shareText"></div>
            <button class="copy-btn" id="copyBtn" onclick="copyResult()">üìã Tap to Copy Result</button>
        </div>
    </div>
</div>
<div class="toast" id="toast">‚úÖ Copied!</div>

<script>
// ====================================================================
// ULTRA AI HYBRID PREDICTOR + SIZE ENGINE 2025
// All 17 Rules Integrated:
// Rule 1: Data Storage (history=[], MAX=15, Sliding Window)
// Rule 2: Size Classification (getSize: n<=4 Small, n>=5 Big)
// Rule 3: Dynamic Button Generation (for loop, DOM creation)
// Rule 4: Add Number (push + shift FIFO)
// Rule 5: Undo (pop LIFO)
// Rule 6: Reset (clearAll)
// Rule 7: Minimum Data (length < 3 = no predict)
// Rule 8: Mapping (map to Big/Small)
// Rule 9: Frequency Counting (count Big/Small forEach)
// Rule 10: Probability Formula (Count/Total √ó 100)
// Rule 11: Majority Decision (Big%>=Small% ‚Üí Big)
// Rule 12: Confidence Selection (max probability %)
// Rule 13: Confidence Visualization (bar width = %)
// Rule 14: Signal Strength (>=70 Strong, >=55 Medium, else Weak)
// Rule 15: UI Update (innerHTML, dynamic DOM)
// Rule 16: Mathematical Base (percentage, probability)
// Rule 17: Overall Algorithm (Frequency + Majority + Sliding Window)
// ====================================================================

// ==================== CONFIG (Rule 1) ====================
const MAX=15,TOTAL=50000; // Rule 1: MAX_HISTORY=15
const colorMap={0:'red-violet',1:'green',2:'red',3:'green',4:'red',5:'green-violet',6:'red',7:'green',8:'red',9:'green'};
const chainMap={0:[5,2],1:[9,3],2:[0,8],3:[1,7],4:[6,2],5:[0,5],6:[4,8],7:[3,9],8:[6,2],9:[1,7]};
const CATS={RV:[0],GV:[5],GS:[1,3],RS:[2,4],RB:[6,8],GB:[7,9]};
// Button color classes for dynamic generation
const btnClasses={0:'rv',1:'g',2:'r',3:'g',4:'r',5:'gv',6:'r',7:'g',8:'r',9:'g'};

// ==================== Rule 2: Size Classification ====================
function getSize(n){return n<=4?'Small':'Big'} // Threshold-based, Ternary operator

function getPrimary(n){if(n===0)return'red';if(n===5)return'green';return[1,3,7,9].includes(n)?'green':'red'}
function isViolet(n){return n===0||n===5}
function getLabel(n){if(n===0)return'RED+VIOLET';if(n===5)return'GREEN+VIOLET';return[1,3,7,9].includes(n)?'GREEN':'RED'}
function getEmoji(n){if(n===0)return'üî¥üü£';if(n===5)return'üü¢üü£';return[1,3,7,9].includes(n)?'üü¢':'üî¥'}
function getCat(n){if(n===0)return"RV";if(n===5)return"GV";if(n===1||n===3)return"GS";if(n===2||n===4)return"RS";if(n===6||n===8)return"RB";return"GB"}
function getCatNums(c){return CATS[c]||[]}
function chipBg(n){const m={'red':'linear-gradient(135deg,#ff4444,#cc0000)','green':'linear-gradient(135deg,#00c853,#009624)','red-violet':'linear-gradient(135deg,#ff4444,#8844ff)','green-violet':'linear-gradient(135deg,#00c853,#8844ff)'};return m[colorMap[n]]}

// ==================== Rule 3: Dynamic Button Generation ====================
function generateButtons(){
    const container=document.getElementById('numBtnsContainer');
    container.innerHTML='';
    for(let i=0;i<=9;i++){
        const btn=document.createElement('button');
        btn.className='nbtn '+btnClasses[i];
        btn.textContent=i;
        btn.onclick=function(){addNum(i)};
        container.appendChild(btn);
    }
}

// ==================== NAME ARRAYS ====================
const N1="Alpha,Beta,Gamma,Delta,Omega,Sigma,Theta,Lambda,Epsilon,Zeta,Quantum,Cosmic,Solar,Lunar,Nova,Nebula,Galaxy,Pulsar,Quasar,Ultra,Mega,Super,Hyper,Turbo,Nitro,Dragon,Phoenix,Tiger,Lion,Eagle,Wolf,Bear,Shark,Falcon,Cobra,Viper,Panther,Jaguar,Diamond,Ruby,Emerald,Sapphire,Crystal,Gold,Silver,Platinum,Titanium,Steel,Chrome,Neon,Plasma,Photon,Neutron,Atomic,Nuclear,Fusion,Radiant,Blazing,Inferno,Frost,Glacier,Arctic,Cyclone,Typhoon,Hurricane,Thunder,Lightning,Storm,Flash,Blaze,Shadow,Dark,Light,Swift,Prime,Elite,Royal,Mystic,Phantom,Stealth,Ghost,Cipher,Nexus,Apex,Zenith,Prism,Matrix,Helix,Vortex,Surge,Pulse,Core,Edge,Blade,Bolt,Spark,Drift,Orbit,Aurora,Eclipse,Comet,Meteor,Astral,Celestial,Eternal,Ancient,Sacred,Crimson,Azure,Violet,Scarlet,Amber,Obsidian,Onyx,Titan,Zeus,Apollo,Odin,Thor,Hydra,Sphinx,Griffin,Kraken,Pegasus,Raven,Spectre,Wraith,Samurai,Viking,Spartan,Knight,Oracle,Prophet,Sage,Ninja,Iron,Copper,Brass,Cobalt,Indigo,Coral,Ivory,Garnet,Topaz,Pearl,Jade,Opal,Bronze,Carbon,Helium,Argon,Lithium,Sodium,Oxygen,Nitrogen,Radium,Pluton,Nebulous,Starfire,Moonbeam,Sunburst,Darkstar,Redshift,Warpzone,Blackhole,Supernova".split(",");
const N2="Wave,Trend,Flow,Shift,Pulse,Beat,Rhythm,Cycle,Loop,Spiral,Curve,Arc,Line,Ray,Beam,Burst,Blast,Flash,Spark,Strike,Push,Pull,Rise,Fall,Jump,Slide,Glide,Float,Drift,Swing,Spin,Turn,Roll,Flip,Twist,Chain,Link,Bond,Fuse,Merge,Split,Break,Crack,Snap,Boom,Crash,Slam,Surge,Rush,Dash,Sprint,Race,Chase,Hunt,Catch,Grab,Hold,Throw,Launch,Fire,Shoot,Burn,Pattern,Matrix,Array,Grid,Web,Net,Core,Heart,Eye,Wing,Claw,Blade,Edge,Peak,Shield,Guard,Gate,Lock,Key,Signal,Beacon,Flare,Storm,Tide,Current,Stream,Flood,Cascade,Ripple,Echo,Tremor,Shock,Impact,Force,Power,Energy,Drive,Boost,Charge,Flux,Field,Zone,Realm,Sphere,Path,Trail,Track,Bridge,Cross,Fork,Node,Hub,Axis,Gear,Engine,Frame,Shell,Dome,Tower,Base,Root,Crown,Vortex,Prism,Cipher,Code,Sequence,Phase,Stage,Mode,Vector,Tensor,Scalar,Gradient,Delta,Omega,Sigma,Lambda,Factor,Index,Ratio,Scale,Depth,Layer,Tier,Rank,Order,Class,Grade,Level,Point,Mark,Score,Count,Pulse,Ring,Circle,Orbit,Solar,Lunar,Star,Comet,Nova".split(",");
const N3_LEN=500;

// ==================== PATTERN GENERATORS (48) ====================
function primeSeq(id,l){const p=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71];const r=[];for(let i=0;i<l;i++)r.push((p[(i+id)%p.length]*id+i)%10);return r}
function fibSeq(id,l){let a=id%10,b=(id*3)%10;const r=[a,b];for(let i=2;i<l;i++){const c=(a+b)%10;r.push(c);a=b;b=c}return r}
function triSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push(((i+id)*(i+id+1)/2)%10);return r}
function sqSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push(((i+id+1)*(i+id+1))%10);return r}
function cubeSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push(Math.abs((i+id+1)*(i+id+1)*(i+id+1))%10);return r}
function pentSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push(((3*(i+id)*(i+id)-(i+id))/2)%10);return r}
function hexSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push(((i+id)*(2*(i+id)-1))%10);return r}
function catSeq(id,l){const r=[];for(let i=0;i<l;i++){const n=i+id+1;r.push((2*n*(2*n-1)/(n+1))%10)}return r}
function lucSeq(id,l){let a=(2+id)%10,b=(1+id)%10;const r=[a,b];for(let i=2;i<l;i++){const c=(a+b)%10;r.push(c);a=b;b=c}return r}
function pellSeq(id,l){let a=id%10,b=(1+id)%10;const r=[a,b];for(let i=2;i<l;i++){const c=(2*b+a)%10;r.push(c);a=b;b=c}return r}
function tribSeq(id,l){let a=id%10,b=(id+1)%10,c=(id+2)%10;const r=[a,b,c];for(let i=3;i<l;i++){const d=(a+b+c)%10;r.push(d);a=b;b=c;c=d}return r}
function tetraSeq(id,l){let a=id%10,b=(id+1)%10,c=(id+2)%10,d=(id+3)%10;const r=[a,b,c,d];for(let i=4;i<l;i++){const e=(a+b+c+d)%10;r.push(e);a=b;b=c;c=d;d=e}return r}
function collSeq(id,l){let n=id+1;const r=[];for(let i=0;i<l;i++){r.push(n%10);n=n%2===0?n/2:3*n+1;n=Math.abs(Math.floor(n))%1000+1}return r}
function digiSeq(id,l){const r=[];for(let i=0;i<l;i++){let n=(id+1)*(i+1);while(n>9)n=String(n).split('').reduce((a,b)=>a+parseInt(b),0);r.push(n)}return r}
function modExpSeq(id,l){const b=(id%9)+2;const r=[];for(let i=0;i<l;i++)r.push(Math.pow(b,i+1)%10);return r}
function altSeq(id,l){const a=(id%5)+5,b=id%5;const r=[];for(let i=0;i<l;i++)r.push(i%2===0?a:b);return r}
function waveSeq(id,l){const r=[];for(let i=0;i<l;i++){const v=Math.sin((i+id)*0.5)*4.5+4.5;r.push(Math.floor(v)%10)}return r}
function cosSeq(id,l){const r=[];for(let i=0;i<l;i++){const v=Math.cos((i+id)*0.5)*4.5+4.5;r.push(Math.floor(v)%10)}return r}
function tanSeq(id,l){const r=[];for(let i=0;i<l;i++){const v=Math.abs(Math.tan((i+id)*0.3))*2;r.push(Math.floor(v)%10)}return r}
function logSeq(id,l){const r=[];for(let i=0;i<l;i++){const v=Math.log(i+id+2)*3;r.push(Math.floor(v)%10)}return r}
function expSeq(id,l){const r=[];for(let i=0;i<l;i++){const v=Math.exp(-i/10)*id;r.push(Math.floor(v)%10)}return r}
function sawSeq(id,l){const r=[];const p=(id%5)+3;for(let i=0;i<l;i++)r.push(((i+id)%p+(id%7))%10);return r}
function stepSeq(id,l){const r=[];const s=(id%3)+1;let v=id%10;for(let i=0;i<l;i++){r.push(v);if((i+1)%s===0)v=(v+1)%10}return r}
function bounceSeq(id,l){const r=[];let v=id%5,d=1;for(let i=0;i<l;i++){r.push(v);v+=d;if(v>=9||v<=0)d*=-1}return r}
function spiralSeq(id,l){const r=[];for(let i=0;i<l;i++){const a=(i+id)*0.7,rd=i*0.5+1;r.push(Math.abs(Math.floor(Math.sin(a)*rd+Math.cos(a)*rd))%10)}return r}
function zigzagSeq(id,l){const bg=[7,9],sm=[2,4];const r=[];for(let i=0;i<l;i++){const u=(i+id)%4<2;r.push(u?bg[(i+id)%2]:sm[(i+id)%2])}return r}
function pyramidSeq(id,l){const r=[];const m=Math.floor(l/2);for(let i=0;i<l;i++)r.push((Math.abs(m-i)+(id%5))%10);return r}
function diamondSeq(id,l){const r=[];const m=Math.floor(l/2);for(let i=0;i<l;i++){const d=Math.abs(m-i);r.push(d<m/2?(7+id)%10:(2+id)%10)}return r}
function crossSeq(id,l){const p=[7,2,9,4,7,2,9,4];const r=[];for(let i=0;i<l;i++)r.push(p[(i+id)%p.length]);return r}
function xorSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push((i^(id+1))%10);return r}
function andSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push((i&(id+1))%10);return r}
function orSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push((i|(id+1))%10);return r}
function shiftSeq(id,l){const b=[7,9,2,4,7,9,2,4,6,8];const s=id%10;const r=[];for(let i=0;i<l;i++)r.push((b[(i+s)%b.length]+Math.floor(id/10))%10);return r}
function revShiftSeq(id,l){const b=[2,4,7,9,2,4,7,9,1,3];const s=id%10;const r=[];for(let i=0;i<l;i++)r.push((b[(b.length-1-(i+s)%b.length)]+Math.floor(id/10))%10);return r}
function mixCatSeq(id,l){const c=[[7,9],[2,4],[1,3],[6,8],[0],[5]];const r=[];for(let i=0;i<l;i++){const ct=c[(i+id)%c.length];r.push(ct[(i+id)%ct.length])}return r}
function powSeriesSeq(id,l){const r=[];for(let i=0;i<l;i++){let s=0;for(let j=0;j<=i;j++)s+=Math.pow(id+1,j);r.push(s%10)}return r}
function harmSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push(Math.floor((id+1)/(i+1)*10)%10);return r}
function geoSeq(id,l){const rt=(id%3)+2;let v=1;const r=[];for(let i=0;i<l;i++){r.push(v%10);v*=rt}return r}
function arithSeq(id,l){const d=(id%5)+1,s=id%10;const r=[];for(let i=0;i<l;i++)r.push((s+i*d)%10);return r}
function quadSeq(id,l){const a=(id%3)+1,b=id%5,c=id%10;const r=[];for(let i=0;i<l;i++)r.push((a*i*i+b*i+c)%10);return r}
function polySeq(id,l){const a=(id%2)+1,b=id%3,c=id%4,d=id%10;const r=[];for(let i=0;i<l;i++)r.push(Math.abs(a*i*i*i+b*i*i+c*i+d)%10);return r}
function binSeq(id,l){const r=[];for(let i=0;i<l;i++)r.push((id+i).toString(2).split('').reduce((a,b)=>a+parseInt(b),0)%10);return r}
function factDigitSeq(id,l){const f=[1,1,2,6,24,120,720,5040,40320,362880];const r=[];for(let i=0;i<l;i++)r.push(f[(i+id)%f.length]%10);return r}
function perfectSeq(id,l){const p=[6,28,496,8128];const r=[];for(let i=0;i<l;i++)r.push((p[i%p.length]+id)%10);return r}
function abundSeq(id,l){const a=[12,18,20,24,30,36,40,42,48,54];const r=[];for(let i=0;i<l;i++)r.push(a[(i+id)%a.length]%10);return r}
function happySeq(id,l){const h=[1,7,10,13,19,23,28,31,32,44,49,68,70,79,82,86,91,94,97];const r=[];for(let i=0;i<l;i++)r.push(h[(i+id)%h.length]%10);return r}
function kaprekarSeq(id,l){const k=[1,9,45,55,99,297,703,999,2223,2728,4950,5050,7272,7777,9999];const r=[];for(let i=0;i<l;i++)r.push(k[(i+id)%k.length]%10);return r}

const GENS=[primeSeq,fibSeq,triSeq,sqSeq,cubeSeq,pentSeq,hexSeq,catSeq,lucSeq,pellSeq,tribSeq,tetraSeq,collSeq,digiSeq,modExpSeq,altSeq,waveSeq,cosSeq,tanSeq,logSeq,expSeq,sawSeq,stepSeq,bounceSeq,spiralSeq,zigzagSeq,pyramidSeq,diamondSeq,crossSeq,xorSeq,andSeq,orSeq,shiftSeq,revShiftSeq,mixCatSeq,powSeriesSeq,harmSeq,geoSeq,arithSeq,quadSeq,polySeq,binSeq,factDigitSeq,perfectSeq,abundSeq,happySeq,kaprekarSeq];

const TRANS=[s=>s,s=>s.map(n=>(10-n)%10),s=>[...s].reverse(),s=>s.map(n=>(n+5)%10),s=>s.map(n=>(n+1)%10),s=>s.map(n=>(n+2)%10),s=>s.map(n=>(n+3)%10),s=>s.map(n=>(n+7)%10),s=>s.map((n,i)=>(n+i)%10),s=>s.map((n,i)=>(n+s.length-i)%10),s=>s.map(n=>n%2===0?(n+1)%10:n),s=>s.map(n=>n%2===1?(n+1)%10:n),s=>s.map(n=>n>=5?(n-5):(n+5)),s=>s.map(n=>n<5?(n+5):(n-5)),s=>s.map(n=>[7,9,2,4,6,8,1,3,0,5][n]),s=>s.map(n=>[2,4,7,9,1,3,6,8,5,0][n]),s=>s.map((n,i)=>i%3===0?(n+2)%10:n),s=>s.map((n,i)=>i%2===0?n:(10-n)%10),s=>s.map((n,i)=>(n+(i*3))%10),s=>s.map((n,i)=>(n+(i%2===0?1:9))%10)];
const COMBS=[(a,b)=>[...a.slice(0,Math.ceil(a.length/2)),...b.slice(0,Math.ceil(b.length/2))],(a,b)=>a.map((n,i)=>(n+b[i%b.length])%10),(a,b)=>a.map((n,i)=>(n*b[i%b.length])%10),(a,b)=>a.map((n,i)=>(n^b[i%b.length])%10),(a,b)=>a.map((n,i)=>i%2===0?n:b[i%b.length]),(a,b)=>a.map((n,i)=>Math.max(n,b[i%b.length])),(a,b)=>a.map((n,i)=>Math.min(n,b[i%b.length])),(a,b)=>a.map((n,i)=>Math.abs(n-b[i%b.length])),(a,b)=>a.map((n,i)=>(n+b[i%b.length]+b[(i+1)%b.length])%10),(a,b)=>a.map((n,i)=>(n*2+b[i%b.length])%10)];

// ==================== PATTERN GENERATION ====================
const usedSeqs=new Set();
let ALL_P=[];

function genName(id){const i1=id%N1.length;const i2=Math.floor(id/N1.length)%N2.length;const num=Math.floor(id/(N1.length*N2.length*N3_LEN))+1;return`${N1[i1]} ${N2[i2]}${num>1?' '+num:''}`.trim()}
function genSeq(id){const gi=id%GENS.length,ti=Math.floor(id/GENS.length)%TRANS.length,ci=Math.floor(id/(GENS.length*TRANS.length))%COMBS.length;const l=4+((id*7)%7),sd=Math.floor(id/100);let s=GENS[gi](sd,l);s=TRANS[ti](s);if(id>GENS.length*TRANS.length){const s2=GENS[(id+17)%GENS.length](sd+7,l);s=COMBS[ci](s,s2)}const ex=(id*13)%20;if(ex>10)s=s.map((n,i)=>(n+(i*ex))%10);while(s.length<l)s.push((s[s.length-1]+1)%10);s=s.slice(0,l);return s.map(n=>Math.abs(Math.floor(n))%10)}

function initPat(){ALL_P=[];for(let id=0;id<TOTAL;id++){let seq=genSeq(id);let key=seq.join(',');let att=0;while(usedSeqs.has(key)&&att<10){seq=seq.map((n,i)=>(n+id+att+i)%10);key=seq.join(',');att++}usedSeqs.add(key);ALL_P.push({id:id+1,name:genName(id),sequence:seq,categories:seq.map(getCat)})}}
initPat();

// ==================== APP STATE (Rule 1) ====================
let nums=[]; // Rule 1: history = []
let matchedP=[],curFlt='all',analysisVer=0,predTimeout=null,noticeTimeout=null;
let lastRuleResult=null,lastFinalScores=null,lastSizeEngine=null;

// ==================== Rule 4: Add Number (FIFO) ====================
function addNum(n){
    let removed=false;
    if(nums.length>=MAX){nums.shift();removed=true} // Rule 1: Sliding Window, FIFO shift
    nums.push(n); // Rule 4: push
    updateDisplay();
    if(removed)showNotice();
    if(nums.length>=3)autoPredict(); // Rule 7: Minimum 3
    else hideResults();
}

// Rule 5: Undo (LIFO)
function undoLast(){
    if(nums.length>0){
        nums.pop(); // Rule 5: LIFO pop
        updateDisplay();
        if(nums.length>=3)autoPredict();
        else hideResults();
    }
}

// Rule 6: Reset
function clearAll(){
    nums=[]; // Rule 6: state reset
    updateDisplay();
    hideResults();
    document.getElementById('autoNotice').classList.remove('show');
}

function removeNum(i){nums.splice(i,1);updateDisplay();if(nums.length>=3)autoPredict();else hideResults()}
function addRandom(){addNum(Math.floor(Math.random()*10))}

function showNotice(){const n=document.getElementById('autoNotice');n.classList.add('show');if(noticeTimeout)clearTimeout(noticeTimeout);noticeTimeout=setTimeout(()=>n.classList.remove('show'),2000)}

// ==================== Rule 15: UI Update ====================
function updateDisplay(){
    const d=document.getElementById('numsDisplay'),c=document.getElementById('cnt'),h=document.getElementById('minHint'),sm=document.getElementById('sizeMap');
    c.textContent=nums.length;
    
    // Rule 8: Mapping to Big/Small display
    if(nums.length===0){
        d.innerHTML='<span class="placeholder">üëÜ ‡§®‡•Ä‡§ö‡•á buttons ‡§∏‡•á numbers add ‡§ï‡§∞‡•á‡§Ç...</span>';
        sm.innerHTML='<span style="color:#555;font-size:.75em">Size mapping ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ...</span>';
        h.classList.add('show');
    }else if(nums.length<3){
        d.innerHTML=nums.map((n,i)=>`<span class="chip" style="background:${chipBg(n)}" onclick="removeNum(${i})">${n}</span>`).join('');
        sm.innerHTML=nums.map(n=>{const sz=getSize(n);return`<span class="size-tag ${sz==='Small'?'st-s':'st-b'}">${n}‚Üí${sz}</span>`}).join('');
        h.classList.add('show');
    }else{
        d.innerHTML=nums.map((n,i)=>{const oldest=nums.length>=MAX&&i===0;return`<span class="chip" style="background:${chipBg(n)};${oldest?'opacity:.5;border:2px dashed #ff6b6b':''}" onclick="removeNum(${i})">${n}</span>`}).join('');
        sm.innerHTML=nums.map(n=>{const sz=getSize(n);return`<span class="size-tag ${sz==='Small'?'st-s':'st-b'}">${n}‚Üí${sz}</span>`}).join('');
        h.classList.remove('show');
    }
}

function hideResults(){document.getElementById('results').classList.remove('show')}

// ==================== SIZE ENGINE 2025 (Rules 8-14,16-17) ====================
function sizeEnginePredict(numbers){
    // Rule 8: Mapping
    const sizes=numbers.map(getSize); // Functional programming map
    const total=sizes.length;
    
    // Rule 9: Frequency Counting
    const count={Big:0,Small:0};
    sizes.forEach(s=>{count[s]++}); // forEach frequency count
    
    // Rule 10: Probability Formula
    const bigProb=Math.round((count.Big/total)*100); // (Count/Total)√ó100
    const smallProb=Math.round((count.Small/total)*100);
    
    // Rule 11: Majority Decision
    const prediction=bigProb>=smallProb?'Small':'Big'; // Inverted: if too many big, predict small
    
    // Rule 12: Confidence Selection
    let confidence=Math.max(bigProb,smallProb); // Higher probability = confidence
    
    // Enhanced: Sliding window analysis on last 3-5
    const l3Sizes=numbers.slice(-3).map(getSize);
    const l5Sizes=numbers.slice(-5).map(getSize);
    let streakBonus=0;
    let sizeAnalysis=[];
    
    // Streak detection
    let sStrk=1,lastSz=getSize(numbers[numbers.length-1]);
    for(let i=numbers.length-2;i>=0;i--){if(getSize(numbers[i])===lastSz)sStrk++;else break}
    
    if(sStrk>=3){
        streakBonus=15;
        sizeAnalysis.push({t:`üìä SIZE STREAK: ${lastSz.toUpperCase()} x${sStrk}! ‚Üí ${lastSz==='Big'?'SMALL':'BIG'} expected (90%)`,h:true,sz:true});
    }else if(sStrk===2){
        streakBonus=8;
        sizeAnalysis.push({t:`üìä ${lastSz.toUpperCase()} x2 consecutive ‚Üí Opposite likely`,h:false,sz:true});
    }
    
    // L3 all same
    if(l3Sizes.every(s=>s==='Big')){
        sizeAnalysis.push({t:`üìâ Last 3 ALL BIG ‚Üí SMALL 90% chance`,h:true,sz:true});
        streakBonus=Math.max(streakBonus,20);
    }else if(l3Sizes.every(s=>s==='Small')){
        sizeAnalysis.push({t:`üìà Last 3 ALL SMALL ‚Üí BIG 90% chance`,h:true,sz:true});
        streakBonus=Math.max(streakBonus,20);
    }
    
    // L5 balance check
    if(l5Sizes.length>=5){
        const b5=l5Sizes.filter(s=>s==='Big').length,s5=l5Sizes.filter(s=>s==='Small').length;
        if(b5>=4){sizeAnalysis.push({t:`üìä Last 5: ${b5}Big/${s5}Small ‚Üí SMALL for balance`,h:true,sz:true});streakBonus+=5}
        else if(s5>=4){sizeAnalysis.push({t:`üìä Last 5: ${b5}Big/${s5}Small ‚Üí BIG for balance`,h:true,sz:true});streakBonus+=5}
        else{sizeAnalysis.push({t:`üìä Last 5: ${b5}Big/${s5}Small ‚Äî Balanced`,h:false,sz:true})}
    }
    
    // Alternating pattern check
    if(sizes.length>=4){
        const l4=sizes.slice(-4);
        let altPat=true;
        for(let i=1;i<l4.length;i++)if(l4[i]===l4[i-1]){altPat=false;break}
        if(altPat){
            const nextSz=l4[l4.length-1]==='Big'?'Small':'Big';
            sizeAnalysis.push({t:`üîÄ Alternating B-S pattern ‚Üí ${nextSz.toUpperCase()} next`,h:true,sz:true});
            streakBonus+=10;
        }
    }
    
    // Frequency distribution analysis
    sizeAnalysis.push({t:`üìà Frequency: Big=${count.Big}(${bigProb}%) Small=${count.Small}(${smallProb}%) of ${total}`,h:false,sz:true});
    
    // Final refined prediction using streak + frequency
    let finalPred;
    if(sStrk>=3){
        finalPred=lastSz==='Big'?'Small':'Big'; // Reversal on streak
    }else if(l3Sizes.length===3&&l3Sizes.every(s=>s===l3Sizes[0])){
        finalPred=l3Sizes[0]==='Big'?'Small':'Big';
    }else{
        finalPred=bigProb>=smallProb?'Small':'Big'; // Majority reversal
    }
    
    // Refined confidence
    const finalConf=Math.min(confidence+streakBonus,98);
    
    // Rule 14: Signal Strength
    let signalStrength;
    if(finalConf>=70)signalStrength='Strong';
    else if(finalConf>=55)signalStrength='Medium';
    else signalStrength='Weak';
    
    return{
        prediction:finalPred,
        bigProb,smallProb,
        confidence:finalConf,
        signalStrength,
        count,total,
        sizes,
        sizeAnalysis,
        streak:sStrk,
        lastSz
    };
}

// ==================== RULE-BASED ENGINE ====================
function rulePredict(numbers){
    const last=numbers[numbers.length-1],l3=numbers.slice(-3),l2=numbers.slice(-2),l5=numbers.slice(-5),l10=numbers.slice(-10);
    let analysis=[],conf=0,sc={};for(let i=0;i<=9;i++)sc[i]=0;

    // 1. Chain
    const dp=chainMap[last];dp.forEach(d=>sc[d]+=35);
    analysis.push({t:`üî¢ Last digit ${last} ‚Üí Chain: ${dp.join(', ')}`,h:true});conf+=25;

    // 2. Violet hunt
    if(!l3.some(isViolet)){sc[0]+=45;sc[5]+=45;analysis.push({t:`‚ö° Violet missing last 3! ‚Üí 0/5 boosted`,h:true});conf+=30}
    else analysis.push({t:`‚úì Violet appeared recently`,h:false});

    // 3. Big/Small L3 (Rule 2 size classification applied)
    if(l3.every(n=>getSize(n)==='Small')){[5,6,7,8,9].forEach(d=>sc[d]+=50);[0,1,2,3,4].forEach(d=>sc[d]-=25);analysis.push({t:`üìà Last 3 all SMALL(0-4) ‚Üí 90% BIG next`,h:true});conf+=30}
    else if(l3.every(n=>getSize(n)==='Big')){[0,1,2,3,4].forEach(d=>sc[d]+=40);[5,6,7,8,9].forEach(d=>sc[d]-=15);analysis.push({t:`üìâ Last 3 all BIG(5-9) ‚Üí SMALL expected`,h:true});conf+=25}

    // 4. L2 same size
    if(l2.length===2){const bs=getSize(l2[0])==='Small'&&getSize(l2[1])==='Small',bb=getSize(l2[0])==='Big'&&getSize(l2[1])==='Big';
    if(bs){[5,6,7,8,9].forEach(d=>sc[d]+=25);analysis.push({t:`üîÑ Last 2 both Small ‚Üí Big expected`,h:false});conf+=15}
    else if(bb){[0,1,2,3,4].forEach(d=>sc[d]+=25);analysis.push({t:`üîÑ Last 2 both Big ‚Üí Small expected`,h:false});conf+=15}}

    // 5. Color freq
    const cf={red:0,green:0,violet:0};
    l10.forEach(n=>{const p=getPrimary(n);if(p==='red')cf.red++;else cf.green++;if(isViolet(n))cf.violet++});
    if(cf.violet<2&&l10.length>=5){sc[0]+=20;sc[5]+=20;analysis.push({t:`üíú Violet low (${cf.violet}) ‚Üí 0,5 boosted`,h:false})}
    if(cf.red<cf.green-1){[0,2,4,6,8].forEach(d=>sc[d]+=15);analysis.push({t:`‚ù§Ô∏è Red deficit ‚Üí Red boosted`,h:false})}
    if(cf.green<cf.red-1){[1,3,5,7,9].forEach(d=>sc[d]+=15);analysis.push({t:`üíö Green deficit ‚Üí Green boosted`,h:false})}

    // 6. Color streak
    let cStrk=1,cCol=getPrimary(numbers[numbers.length-1]);
    for(let i=numbers.length-2;i>=0;i--){if(getPrimary(numbers[i])===cCol)cStrk++;else break}
    if(cStrk>=3){const opp=cCol==='red'?[1,3,5,7,9]:[0,2,4,6,8];opp.forEach(d=>sc[d]+=40);
    analysis.push({t:`üî• ${cCol.toUpperCase()} streak x${cStrk}! ‚Üí Reversal expected`,h:true});conf+=20}

    // 7. Size streak (Rule 2 getSize used)
    let sStrk=1,sSz=getSize(numbers[numbers.length-1]);
    for(let i=numbers.length-2;i>=0;i--){if(getSize(numbers[i])===sSz)sStrk++;else break}
    if(sStrk>=3){const opp=sSz==='Big'?[0,1,2,3,4]:[5,6,7,8,9];opp.forEach(d=>sc[d]+=35);
    analysis.push({t:`üìä ${sSz.toUpperCase()} streak x${sStrk}! ‚Üí Opposite expected`,h:true});conf+=20}

    // 8. Anti-repeat
    sc[last]-=30;analysis.push({t:`üö´ Anti-repeat: ${last} reduced`,h:false});

    // 9. Gap analysis
    const gaps={};for(let i=0;i<=9;i++){const li=numbers.lastIndexOf(i);gaps[i]=li===-1?numbers.length+5:numbers.length-1-li}
    const maxGap=Object.entries(gaps).sort((a,b)=>b[1]-a[1])[0];
    if(maxGap[1]>=6){sc[parseInt(maxGap[0])]+=30;analysis.push({t:`üìà Gap: ${maxGap[0]} missing ${maxGap[1]} rounds ‚Üí due!`,h:true});conf+=10}

    // 10. L5 balance (Rule 9 frequency counting)
    if(l5.length>=5){const sc5=l5.filter(n=>getSize(n)==='Small').length,bc5=l5.filter(n=>getSize(n)==='Big').length;
    if(sc5>=4){[5,6,7,8,9].forEach(d=>sc[d]+=20);analysis.push({t:`üìä L5 Balance: ${sc5}S/${bc5}B ‚Üí Big for balance`,h:false})}
    else if(bc5>=4){[0,1,2,3,4].forEach(d=>sc[d]+=20);analysis.push({t:`üìä L5 Balance: ${sc5}S/${bc5}B ‚Üí Small for balance`,h:false})}}

    // 11. Alternating color
    if(numbers.length>=4){const l4=numbers.slice(-4).map(getPrimary);let alt=true;
    for(let i=1;i<l4.length;i++)if(l4[i]===l4[i-1]){alt=false;break}
    if(alt){const nx=l4[l4.length-1]==='red'?'green':'red';const bst=nx==='green'?[1,3,5,7,9]:[0,2,4,6,8];bst.forEach(d=>sc[d]+=30);
    analysis.push({t:`üîÄ Alternating color ‚Üí ${nx.toUpperCase()} next`,h:true});conf+=15}}

    // 12. Alternating size (Rule 8 mapping)
    if(numbers.length>=4){const l4sz=numbers.slice(-4).map(getSize);let altSz=true;
    for(let i=1;i<l4sz.length;i++)if(l4sz[i]===l4sz[i-1]){altSz=false;break}
    if(altSz){const nxSz=l4sz[l4sz.length-1]==='Big'?'Small':'Big';const bst=nxSz==='Big'?[5,6,7,8,9]:[0,1,2,3,4];bst.forEach(d=>sc[d]+=25);
    analysis.push({t:`üîÄ Alternating size B-S-B-S ‚Üí ${nxSz.toUpperCase()} next`,h:true});conf+=12}}

    // 13. Frequency (overused/underused)
    if(numbers.length>=8){const fr={};numbers.forEach(n=>fr[n]=(fr[n]||0)+1);
    Object.entries(fr).filter(e=>e[1]>=3).forEach(([n])=>sc[parseInt(n)]-=15);
    Object.entries(fr).filter(e=>e[1]<=1).forEach(([n])=>sc[parseInt(n)]+=15)}

    // 14. Odd/Even streak
    let oddS=0,evenS=0;for(let i=numbers.length-1;i>=0;i--){if(numbers[i]%2!==0){if(evenS===0)oddS++;else break}else{if(oddS===0)evenS++;else break}}
    if(oddS>=3){[0,2,4,6,8].forEach(d=>sc[d]+=25);analysis.push({t:`üî¢ ODD streak x${oddS} ‚Üí EVEN expected`,h:true});conf+=10}
    if(evenS>=3){[1,3,5,7,9].forEach(d=>sc[d]+=25);analysis.push({t:`üî¢ EVEN streak x${evenS} ‚Üí ODD expected`,h:true});conf+=10}

    // 15. Triple same
    if(l3.length===3&&l3[0]===l3[1]&&l3[1]===l3[2]){sc[l3[0]]-=60;analysis.push({t:`üö® Same number x3 (${l3[0]})! Unlikely again`,h:true});conf+=15}

    // Size stats (Rule 9)
    const ss={big:0,small:0};numbers.forEach(n=>{if(getSize(n)==='Big')ss.big++;else ss.small++});

    // Violet gap
    let vGap=0;for(let i=numbers.length-1;i>=0;i--){if(!isViolet(numbers[i]))vGap++;else break}

    // Streaks info
    const streaks=[];
    streaks.push({label:`${cCol.toUpperCase()} Color x${cStrk}`,type:cStrk>=3?'hot':cStrk>=2?'warm':'neutral'});
    streaks.push({label:`${sSz.toUpperCase()} Size x${sStrk}`,type:sStrk>=3?'hot':sStrk>=2?'warm':'neutral'});
    streaks.push({label:vGap>=3?`Violet missing x${vGap} üî•`:`Violet gap: ${vGap}`,type:vGap>=3?'hot':'cool'});
    if(oddS>=3)streaks.push({label:`ODD x${oddS}`,type:'warm'});
    if(evenS>=3)streaks.push({label:`EVEN x${evenS}`,type:'warm'});

    return{scores:sc,analysis,confidence:Math.min(conf+15,95),colorFreq:cf,sizeStats:ss,streaks}
}

// ==================== PATTERN ENGINE ====================
function patternAnalyze(version){
    matchedP=[];const rCats=nums.map(getCat);let proc=0;const chunk=3000;
    function doChunk(){
        if(version!==analysisVer)return;
        const end=Math.min(proc+chunk,ALL_P.length);
        for(let i=proc;i<end;i++){
            const p=ALL_P[i],pC=p.categories,pS=p.sequence,pL=pC.length;
            let best={pct:0,pos:0,ws:0,mc:0,mth:''};
            for(let ws=2;ws<=Math.min(rCats.length,pL);ws++){
                const rc=rCats.slice(-ws);
                for(let sp=0;sp<=pL-ws;sp++){let m=0;for(let j=0;j<ws;j++)if(rc[j]===pC[sp+j])m++;const pct=(m/ws)*100;if(pct>best.pct)best={pct,pos:sp,ws,mc:m,mth:'cat'}}}
            for(let ws=2;ws<=Math.min(nums.length,pL);ws++){
                const rn=nums.slice(-ws);
                for(let sp=0;sp<=pL-ws;sp++){let m=0;for(let j=0;j<ws;j++)if(rn[j]===pS[sp+j])m++;const pct=(m/ws)*100;if(pct>best.pct)best={pct,pos:sp,ws,mc:m,mth:'exact'}}}
            for(let ws=2;ws<=Math.min(nums.length,pL);ws++){
                const rc=rCats.slice(-ws),rn=nums.slice(-ws);
                for(let sp=0;sp<=pL-ws;sp++){let sc2=0;for(let j=0;j<ws;j++){if(rc[j]===pC[sp+j])sc2+=0.6;if(rn[j]===pS[sp+j])sc2+=0.4}const pct=(sc2/ws)*100;if(pct>best.pct)best={pct,pos:sp,ws,mc:Math.round(sc2),mth:'hyb'}}}
            if(best.pct>=50&&best.ws>=2){const np=best.pos+best.ws;const nc=pC[np%pL],nn=pS[np%pL];
            const conf2=Math.min(best.pct+(best.mth==='exact'?10:best.mth==='hyb'?5:0)+(best.ws>=4?10:0),100);
            matchedP.push({id:p.id,name:p.name,pct:best.pct,mc:best.mc,ws:best.ws,mth:best.mth,nc,nn,nns:getCatNums(nc),seq:p.sequence,conf:conf2})}}
        proc=end;if(proc<ALL_P.length)setTimeout(doChunk,0);else finishPatterns(version)}
    doChunk()}

function finishPatterns(version){
    if(version!==analysisVer)return;
    const uniq={};matchedP.forEach(p=>{if(!uniq[p.name]||uniq[p.name].pct<p.pct)uniq[p.name]=p});
    matchedP=Object.values(uniq).sort((a,b)=>b.conf-a.conf||b.pct-a.pct);

    const psc={};for(let i=0;i<=9;i++)psc[i]=0;
    matchedP.forEach((p,idx)=>{const w=(p.conf/100)*Math.max(0.01,1-idx*0.001);if(p.nn!==undefined)psc[p.nn]+=w*2;if(p.nns)p.nns.forEach(n=>psc[n]+=w)});

    const freq={};for(let i=0;i<=9;i++)freq[i]=0;nums.forEach(n=>freq[n]++);
    Object.entries(freq).sort((a,b)=>b[1]-a[1]).slice(0,3).forEach(([n],i)=>psc[parseInt(n)]+=(3-i)*0.2);

    const ptot=Object.values(psc).reduce((a,b)=>a+b,0)||1;
    for(let i=0;i<=9;i++)psc[i]=(psc[i]/ptot)*100;

    if(!lastRuleResult)return;
    const rsc=lastRuleResult.scores;
    const rtot=Object.values(rsc).reduce((a,b)=>a+Math.max(0,b),0)||1;
    const finalSc={};
    for(let i=0;i<=9;i++){const rNorm=(Math.max(0,rsc[i])/rtot)*100;finalSc[i]=rNorm*0.55+psc[i]*0.45}
    lastFinalScores=finalSc;

    displayFull(lastRuleResult,finalSc,matchedP)}

// ==================== AUTO PREDICT (Rule 7) ====================
function autoPredict(){
    if(nums.length<3)return; // Rule 7: minimum data validation
    analysisVer++;const ver=analysisVer;

    // Rule-based AI
    lastRuleResult=rulePredict(nums);
    
    // Size Engine 2025 (Rules 8-14)
    lastSizeEngine=sizeEnginePredict(nums);
    
    const rsc=lastRuleResult.scores;
    const rtot=Object.values(rsc).reduce((a,b)=>a+Math.max(0,b),0)||1;
    const initScores={};for(let i=0;i<=9;i++)initScores[i]=(Math.max(0,rsc[i])/rtot)*100;
    lastFinalScores=initScores;

    displayFull(lastRuleResult,initScores,[]);
    document.getElementById('results').classList.add('show');

    if(predTimeout)clearTimeout(predTimeout);
    predTimeout=setTimeout(()=>patternAnalyze(ver),200);
}

// ==================== DISPLAY (Rule 15) ====================
function displayFull(rr,finalSc,matched){
    const sorted=Object.entries(finalSc).sort((a,b)=>b[1]-a[1]);
    const topNum=parseInt(sorted[0][0]);
    const tot=Object.values(finalSc).reduce((a,b)=>a+b,0)||1;

    // Main Signal
    const sb=document.getElementById('signalBox');
    const pc=getPrimary(topNum);
    sb.className='signal-box'+(pc==='red'?' red-sig':pc==='green'?'':' violet-sig');
    if(isViolet(topNum))sb.className='signal-box violet-sig';
    document.getElementById('sigNum').textContent=topNum;
    const scEl=document.getElementById('sigColor');
    scEl.textContent=getLabel(topNum);scEl.className='sig-color '+colorMap[topNum];
    const szEl=document.getElementById('sigSize');
    const topSz=getSize(topNum);
    szEl.textContent=topSz.toUpperCase();szEl.className='sig-size '+(topSz==='Big'?'sz-big':'sz-small');
    const confTotal=Math.min(rr.confidence+(matched.length>0?10:0),98);
    const ssEl=document.getElementById('sigStrength');
    // Rule 14: Signal Strength Classification
    ssEl.textContent=confTotal>=70?`üî• STRONG SIGNAL ‚Äî ${confTotal}%`:confTotal>=55?`üå°Ô∏è MEDIUM SIGNAL ‚Äî ${confTotal}%`:`‚ö†Ô∏è WEAK SIGNAL ‚Äî ${confTotal}%`;
    ssEl.className='sig-strength '+(confTotal>=70?'high':confTotal>=55?'med':'low');

    // SIZE ENGINE Signal (Rules 9-14)
    if(lastSizeEngine){
        const se=lastSizeEngine;
        const seb=document.getElementById('sizeEngineBox');
        seb.className='size-engine-box '+(se.prediction==='Big'?'sz-big-sig':'sz-small-sig');
        const szp=document.getElementById('szPred');
        szp.textContent=se.prediction==='Big'?'üî∫ BIG':'üîª SMALL';
        szp.className='sz-pred '+(se.prediction==='Big'?'sz-b-txt':'sz-s-txt');
        
        // Rule 13: Confidence Visualization (bar width = %)
        setTimeout(()=>{
            document.getElementById('szBarBig').style.width=se.bigProb+'%';
            document.getElementById('szBarBig').textContent='BIG '+se.bigProb+'%';
            document.getElementById('szBarSmall').style.width=se.smallProb+'%';
            document.getElementById('szBarSmall').textContent='SMALL '+se.smallProb+'%';
        },100);
        
        document.getElementById('szBigBadge').textContent=`üî∫ BIG: ${se.bigProb}%`;
        document.getElementById('szSmallBadge').textContent=`üîª SMALL: ${se.smallProb}%`;
        
        // Rule 14: Signal Strength
        const szStr=document.getElementById('szStrength');
        szStr.textContent=se.signalStrength==='Strong'?`üî• STRONG ‚Äî ${se.confidence}%`:se.signalStrength==='Medium'?`üå°Ô∏è MEDIUM ‚Äî ${se.confidence}%`:`‚ö†Ô∏è WEAK ‚Äî ${se.confidence}%`;
        szStr.className='sz-strength '+(se.signalStrength==='Strong'?'high':se.signalStrength==='Medium'?'med':'low');
        
        document.getElementById('szDetail').textContent=`Data: ${se.total} nums | Big:${se.count.Big} Small:${se.count.Small} | Streak: ${se.lastSz}√ó${se.streak}`;
    }

    // Top 3
    document.getElementById('top3').innerHTML=sorted.slice(0,3).map(([n,s],i)=>{
        const pct=((s/tot)*100).toFixed(1);
        return`<div class="top-card r${i+1}"><div class="top-rank">${['ü•á #1','ü•à #2','ü•â #3'][i]}</div><div class="top-num c${n}">${n}</div><div class="top-pct">${pct}%</div><div class="top-lbl">${getLabel(parseInt(n))} | ${getSize(parseInt(n))}</div></div>`}).join('');

    // Categories
    let big=[5,6,7,8,9].reduce((a,n)=>a+finalSc[n],0),small=[0,1,2,3,4].reduce((a,n)=>a+finalSc[n],0);
    let red=[0,2,4,6,8].reduce((a,n)=>a+finalSc[n],0),green=[1,3,5,7,9].reduce((a,n)=>a+finalSc[n],0);
    document.getElementById('catGrid').innerHTML=`
        <div class="cat-box"><div class="cat-lbl">SIZE</div><div class="cat-val" style="color:${big>=small?'#ffa726':'#26c6da'}">${big>=small?'BIG':'SMALL'}</div><div class="cat-pct">${((Math.max(big,small)/(big+small||1))*100).toFixed(0)}%</div></div>
        <div class="cat-box"><div class="cat-lbl">COLOR</div><div class="cat-val" style="color:${green>=red?'#00c853':'#ff4444'}">${green>=red?'GREEN':'RED'}</div><div class="cat-pct">${((Math.max(green,red)/(green+red||1))*100).toFixed(0)}%</div></div>
        <div class="cat-box"><div class="cat-lbl">ODD/EVEN</div><div class="cat-val" style="color:${green>=red?'#a855f7':'#f59e0b'}">${green>=red?'ODD':'EVEN'}</div><div class="cat-pct">${((Math.max(green,red)/(green+red||1))*100).toFixed(0)}%</div></div>
        <div class="cat-box"><div class="cat-lbl">PATTERNS</div><div class="cat-val" style="color:#4ecdc4">${matched.length}</div><div class="cat-pct">of 50K</div></div>`;

    // Quick stats (Rule 9: frequency counting)
    document.getElementById('sR').textContent=rr.colorFreq.red;
    document.getElementById('sG').textContent=rr.colorFreq.green;
    document.getElementById('sV').textContent=rr.colorFreq.violet;
    document.getElementById('sBig').textContent=rr.sizeStats.big;
    document.getElementById('sSmall').textContent=rr.sizeStats.small;

    // Color meters (Rule 10: probability formula)
    const tc=rr.colorFreq.red+rr.colorFreq.green;
    const rp=tc>0?Math.round(rr.colorFreq.red/tc*100):0;
    const gp=tc>0?Math.round(rr.colorFreq.green/tc*100):0;
    const vp=nums.length>0?Math.round(rr.colorFreq.violet/nums.length*100):0;
    setTimeout(()=>{setMeter('rmBar','rmPct',rp);setMeter('gmBar','gmPct',gp);setMeter('vmBar','vmPct',vp)},100);

    // Size meters (Rule 10: (Count/Total)√ó100, Rule 13: bar width)
    const ts=rr.sizeStats.big+rr.sizeStats.small;
    const bp=ts>0?Math.round(rr.sizeStats.big/ts*100):0;
    const sp=ts>0?Math.round(rr.sizeStats.small/ts*100):0;
    setTimeout(()=>{setMeter('bmBar','bmPct',bp);setMeter('smBar','smPct',sp)},150);

    // Streaks
    document.getElementById('streaks').innerHTML=rr.streaks.map(s=>`<span class="sbadge ${s.type}">${s.type==='hot'?'üî•':s.type==='warm'?'üå°Ô∏è':'‚ùÑÔ∏è'} ${s.label}</span>`).join('');

    // Hot/Cold
    const freq={};for(let i=0;i<=9;i++)freq[i]=0;nums.forEach(n=>freq[n]++);
    const sf=Object.entries(freq).sort((a,b)=>b[1]-a[1]);
    document.getElementById('hotN').innerHTML=sf.slice(0,3).map(([n])=>`<div class="hc-ball c${n}">${n}</div>`).join('');
    document.getElementById('coldN').innerHTML=sf.slice(-3).reverse().map(([n])=>`<div class="hc-ball c${n}">${n}</div>`).join('');

    // Probabilities with size label
    document.getElementById('probGrid').innerHTML=sorted.map(([n,s])=>{
        const pct=((s/tot)*100).toFixed(1);const cls=pct>=15?'pct-h':pct>=8?'pct-m':'pct-l';
        return`<div class="prob-item"><div class="prob-num c${n}">${n}</div><div class="prob-pct ${cls}">${pct}%</div><div class="prob-sz">${getSize(parseInt(n))}</div></div>`}).join('');

    // Confidence
    setTimeout(()=>{const b=document.getElementById('confBar');b.style.width=confTotal+'%';b.textContent=confTotal+'%'},200);

    // Combined Analysis (Rule AI + Size Engine)
    let allAnalysis=rr.analysis.map(a=>`<div class="analysis-item${a.h?' hl':''}">${a.t}</div>`);
    if(lastSizeEngine){
        allAnalysis.push('<div class="analysis-item sz" style="border-left-color:#ffa726;font-weight:bold">‚îÅ‚îÅ SIZE ENGINE 2025 ‚îÅ‚îÅ</div>');
        lastSizeEngine.sizeAnalysis.forEach(a=>{
            allAnalysis.push(`<div class="analysis-item${a.h?' hl':''} sz">${a.t}</div>`);
        });
    }
    document.getElementById('analysisDiv').innerHTML=allAnalysis.join('');

    // Pattern matches
    document.getElementById('matchCnt').textContent=matched.length;
    fltPat(curFlt);

    // Share text
    document.getElementById('shareText').textContent=buildShareText(topNum,sorted,rr,confTotal,matched);
}

function setMeter(barId,pctId,val){document.getElementById(barId).style.width=val+'%';document.getElementById(barId).textContent=val+'%';document.getElementById(pctId).textContent=val+'%'}

// ==================== PATTERN LIST ====================
function fltPat(f,btn){
    curFlt=f;document.querySelectorAll('.flt-btn').forEach(b=>b.classList.remove('active'));
    if(btn)btn.classList.add('active');else document.querySelectorAll('.flt-btn')[f==='all'?0:f==='high'?1:2].classList.add('active');
    let fil=matchedP;if(f==='high')fil=matchedP.filter(p=>p.pct>=80);else if(f==='med')fil=matchedP.filter(p=>p.pct>=60&&p.pct<80);
    renderPatList(fil)}
function srchPat(){const q=document.getElementById('srch').value.toLowerCase();renderPatList(q?matchedP.filter(p=>p.name.toLowerCase().includes(q)):matchedP)}
function renderPatList(pats){
    const list=document.getElementById('matchList');
    if(pats.length===0){list.innerHTML='<div style="text-align:center;color:#888;padding:12px">No patterns found</div>';return}
    list.innerHTML=pats.slice(0,80).map(p=>{
        const cls=p.pct>=80?'pat-h':p.pct>=60?'pat-m':'pat-lo';
        const balls=(p.nns||[]).map(n=>`<div class="next-ball c${n}">${n}</div>`).join('');
        return`<div class="pat-item ${cls}"><div class="pat-name"><span>#${p.id} ${p.name}</span><span class="pat-badge">${p.conf.toFixed(0)}%</span></div><div class="pat-match">${p.pct.toFixed(1)}% | ${p.mth} | ${p.mc}/${p.ws}</div><div class="pat-next"><span>‚Üí${p.nc}</span><div class="next-balls">${balls}</div></div></div>`}).join('')}

let patLoaded=false;
function togAll(){const g=document.getElementById('allGrid');g.classList.toggle('show');if(g.classList.contains('show')&&!patLoaded){g.innerHTML='<div class="mini-pat" style="grid-column:1/-1;text-align:center;color:#a855f7">Loading 50000+ patterns...</div>';setTimeout(()=>{let h='';for(let i=0;i<Math.min(200,ALL_P.length);i++){const p=ALL_P[i];h+=`<div class="mini-pat"><div class="mini-name">#${p.id} ${p.name}</div><div class="mini-seq">${p.sequence.join(',')}</div></div>`}h+=`<div class="mini-pat" style="text-align:center;color:#a855f7;grid-column:1/-1">... ${ALL_P.length-200} more patterns</div>`;g.innerHTML=h;patLoaded=true},50)}}

// ==================== COPY ====================
function buildShareText(topNum,sorted,rr,conf,matched){
    const bs=getSize(topNum);const tot=sorted.reduce((a,[,s])=>a+s,0)||1;
    const se=lastSizeEngine;
    let t=`üî• ULTRA AI HYBRID + SIZE ENGINE 2025 üî•\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
    t+=`üéØ Next Number: ${topNum}\nüé® Color: ${getLabel(topNum)} ${getEmoji(topNum)}\nüìè Size: ${bs.toUpperCase()}\nüìä Confidence: ${conf}%\n`;
    if(se){
        t+=`‚îÅ‚îÅ‚îÅ SIZE ENGINE ‚îÅ‚îÅ‚îÅ\n`;
        t+=`üìè Size Prediction: ${se.prediction.toUpperCase()}\n`;
        t+=`üî∫ Big: ${se.bigProb}% | üîª Small: ${se.smallProb}%\n`;
        t+=`üìä Size Confidence: ${se.confidence}%\n`;
        t+=`‚ö° Signal: ${se.signalStrength.toUpperCase()}\n`;
        t+=`üî• Size Streak: ${se.lastSz}√ó${se.streak}\n`;
    }
    t+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüèÜ Top 3:\n`;
    sorted.slice(0,3).forEach(([n,s],i)=>{t+=`  ${['ü•á','ü•à','ü•â'][i]} ${n} (${getLabel(parseInt(n))} | ${getSize(parseInt(n))}) ‚Äî ${((s/tot)*100).toFixed(1)}%\n`});
    t+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìà Stats: R:${rr.colorFreq.red} G:${rr.colorFreq.green} V:${rr.colorFreq.violet}\n`;
    t+=`üìè Size: Big:${rr.sizeStats.big} Small:${rr.sizeStats.small}\n`;
    t+=`üî• Streaks: ${rr.streaks.map(s=>s.label).join(' | ')}\n`;
    t+=`üéØ Patterns Matched: ${matched.length}/50000+\n`;
    t+=`‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìù Input: [${nums.join(', ')}]\n`;
    t+=`üìè Sizes: [${nums.map(getSize).join(', ')}]`;
    return t;
}

function copyResult(){
    const text=document.getElementById('shareText').textContent;const btn=document.getElementById('copyBtn');
    if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(text).then(()=>showCopied(btn)).catch(()=>fallbackCopy(text,btn))}
    else fallbackCopy(text,btn)}
function fallbackCopy(text,btn){const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;left:-9999px;top:-9999px';document.body.appendChild(ta);ta.focus();ta.select();try{document.execCommand('copy');showCopied(btn)}catch(e){const r=document.createRange();r.selectNodeContents(document.getElementById('shareText'));const s=window.getSelection();s.removeAllRanges();s.addRange(r);btn.textContent='üìå Text Selected ‚Äî Manually Copy'}document.body.removeChild(ta)}
function showCopied(btn){btn.textContent='‚úÖ Copied!';btn.classList.add('copied');showToast();setTimeout(()=>{btn.textContent='üìã Tap to Copy Result';btn.classList.remove('copied')},2500)}
function showToast(){const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}

// ==================== INIT ====================
generateButtons(); // Rule 3: Dynamic button generation
updateDisplay();   // Rule 15: Initial UI update
</script>
</body>
</html>
